<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AI Health Coach</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 24px; color: #1a1a2e; }
        .container { max-width: 900px; margin: 0 auto; }
        header { text-align: center; color: white; margin-bottom: 30px; padding: 20px; }
        header h1 { font-size: 2.4rem; margin-bottom: 10px; }
        .card { background: white; border-radius: 12px; padding: 24px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .btn { padding: 12px 20px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; }
        .btn-primary { background: linear-gradient(135deg, #00b0b9, #4cc9f0); color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        textarea { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #e0e0e0; font-size: 1rem; resize: vertical; }
        .message-header { color: #2a9d8f; margin-bottom: 10px; font-size: 0.95rem; }
        .coaching-message { margin-top: 16px; padding: 16px; background: #fff; border-radius: 8px; border-left: 4px solid #2a9d8f; }
        .error-card { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; padding: 16px; border-radius: 8px; margin-top: 16px; }
        footer { text-align: center; color: white; margin-top: 24px; opacity: 0.85; }
    </style>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const connectBtn = document.getElementById('connect-btn');
            const uploadBtn = document.getElementById('upload-fitbit');
            const fitbitFileInput = document.getElementById('fitbit-file');
            const fitbitPreview = document.getElementById('fitbit-preview');
            const fitbitSummary = document.getElementById('fitbit-summary');
            let uploadedFitbitData = null;
            const submitBtn = document.getElementById('submit-prompt');
            const promptInput = document.getElementById('prompt-input');
            const errorSection = document.getElementById('error-section');
            const errorMessage = document.getElementById('error-message');
            const coachingResponse = document.getElementById('coaching-response');
            const coachingText = document.getElementById('coaching-text');
            const checkConfigBtn = document.getElementById('check-config');
            // Modal elements
            const modal = document.getElementById('fitbit-modal');
            const modalClose = document.getElementById('fitbit-modal-close');
            const modalUpload = document.getElementById('fitbit-modal-upload');
            const modalGenDay = document.getElementById('fitbit-modal-generate-day');
            const modalGenWeek = document.getElementById('fitbit-modal-generate-week');
            const modalLoadSample = document.getElementById('fitbit-modal-load-sample');
            const configWarning = document.getElementById('config-warning');
            const configMessage = document.getElementById('config-message');

            // Check configuration on page load
            checkConfig();

            async function checkConfig() {
                // Visual feedback while checking
                if (checkConfigBtn) {
                    checkConfigBtn.disabled = true;
                    const originalText = checkConfigBtn.textContent;
                    checkConfigBtn.textContent = 'Checking...';
                    // restore after check completes
                    var restoreText = () => { checkConfigBtn.disabled = false; checkConfigBtn.textContent = originalText; };
                }
                try {
                    const res = await fetch('https://ai-health-tool-1.onrender.com/health');
                    const data = await res.json();
                    console.log('Health config:', data);
                    
                    if (!data.llmConfigured) {
                        configWarning.style.display = 'block';
                        configMessage.textContent = 'LLM not configured on Render. Set GITHUB_TOKEN, LLM_API_URL, and LLM_MODEL in environment variables, then redeploy.';
                        const s = document.getElementById('config-status');
                        if (s) s.textContent = `Last check: ${new Date().toLocaleTimeString()} • LLM not configured`;
                    } else if (!data.hasGithubToken) {
                        configWarning.style.display = 'block';
                        configMessage.textContent = 'GitHub token missing. Add GITHUB_TOKEN to Render environment.';
                        const s = document.getElementById('config-status');
                        if (s) s.textContent = `Last check: ${new Date().toLocaleTimeString()} • Token missing`;
                    } else {
                        configWarning.style.display = 'none';
                        // Provide success feedback
                        showError('✅ Configuration looks good.');
                        const s = document.getElementById('config-status');
                        if (s) s.textContent = `Last check: ${new Date().toLocaleTimeString()} • OK`;
                    }
                } catch (err) {
                    console.error('Could not check config:', err);
                    configWarning.style.display = 'block';
                    configMessage.textContent = 'Unable to reach health endpoint. Render may be sleeping or CORS blocked.';
                    const s = document.getElementById('config-status');
                    if (s) s.textContent = `Last check: ${new Date().toLocaleTimeString()} • Error`;
                }
                if (typeof restoreText === 'function') restoreText();
            }

            checkConfigBtn.addEventListener('click', checkConfig);

            connectBtn.addEventListener('click', () => {
                window.location.href = 'https://ai-health-tool-1.onrender.com/';
            });

            uploadBtn.addEventListener('click', () => {
                openModal();
            });

            function openModal() {
                if (!modal) return;
                modal.style.display = 'flex';
            }
            function closeModal() {
                if (!modal) return;
                modal.style.display = 'none';
            }
            if (modalClose) modalClose.addEventListener('click', closeModal);
            window.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') closeModal();
            });
            if (modal) modal.addEventListener('click', (e) => {
                if (e.target === modal) closeModal();
            });

            // Modal actions
            if (modalUpload) modalUpload.addEventListener('click', () => {
                fitbitFileInput.click();
            });
            if (modalGenDay) modalGenDay.addEventListener('click', () => {
                const data = generateDummyDayData();
                handleDataSelection(data, '1-day dummy data loaded.');
            });
            if (modalGenWeek) modalGenWeek.addEventListener('click', () => {
                const data = generateDummyFitbitData();
                handleDataSelection(data, '7-day dummy data loaded.');
            });
            if (modalLoadSample) modalLoadSample.addEventListener('click', async () => {
                try {
                    const res = await fetch('sample-fitbit.json');
                    if (!res.ok) throw new Error('HTTP ' + res.status);
                    const json = await res.json();
                    handleDataSelection(json, 'Sample Fitbit data loaded.');
                } catch (e) {
                    showError('Could not load sample data.');
                }
            });

            function handleDataSelection(json, successMsg) {
                uploadedFitbitData = json;
                const summary = buildFitbitSummary(json);
                fitbitSummary.textContent = summary;
                fitbitPreview.style.display = 'block';
                const synopsis = buildUsageSynopsis(json);
                const usage = document.getElementById('data-usage');
                if (usage) {
                    usage.textContent = synopsis;
                    usage.style.display = synopsis ? 'block' : 'none';
                }
                closeModal();
                if (successMsg) showError(successMsg);
            }

            fitbitFileInput.addEventListener('change', async (e) => {
                const file = e.target.files && e.target.files[0];
                if (!file) return;
                try {
                    const text = await file.text();
                    const json = JSON.parse(text);
                    handleDataSelection(json, 'File loaded.');
                } catch (err) {
                    showError('Invalid JSON file');
                    uploadedFitbitData = null;
                    fitbitPreview.style.display = 'none';
                    const usage = document.getElementById('data-usage');
                    if (usage) usage.style.display = 'none';
                }
            });

            function buildFitbitSummary(data) {
                if (!data) return 'No data loaded.';
                try {
                    // Weekly dataset support: data.days = [ { date, activities, heart, sleep } ]
                    if (Array.isArray(data.days) && data.days.length) {
                        const days = data.days;
                        const range = `${days[0].date} → ${days[days.length - 1].date}`;
                        let totalSteps = 0;
                        let totalActive = 0;
                        let totalSleepMin = 0;
                        let rhrSum = 0, rhrCount = 0;
                        days.forEach(d => {
                            const s = d.activities?.summary || {};
                            totalSteps += s.steps || 0;
                            totalActive += (s.fairlyActiveMinutes || 0) + (s.veryActiveMinutes || 0);
                            const sl = d.sleep?.summary?.totalMinutesAsleep;
                            if (typeof sl === 'number') totalSleepMin += sl;
                            const rhr = d.heart?.['activities-heart']?.[0]?.value?.restingHeartRate;
                            if (typeof rhr === 'number') { rhrSum += rhr; rhrCount++; }
                        });
                        const avgSteps = Math.round(totalSteps / days.length);
                        const avgActive = Math.round(totalActive / days.length);
                        const avgSleepHrs = (totalSleepMin / days.length / 60).toFixed(1);
                        const avgRHR = rhrCount ? Math.round(rhrSum / rhrCount) : 'n/a';
                        const last = days[days.length - 1];
                        const lastSum = last.activities?.summary || {};
                        const lastSteps = lastSum.steps || 0;
                        return (
                            `Week: ${range}\n` +
                            `Total Steps: ${totalSteps.toLocaleString()} • Avg/Day: ${avgSteps.toLocaleString()}\n` +
                            `Avg Active Minutes/Day: ${avgActive}\n` +
                            `Avg Sleep/Day: ${avgSleepHrs} h • Avg RHR: ${avgRHR}\n` +
                            `Latest Day (${last.date}) Steps: ${lastSteps.toLocaleString()}`
                        );
                    }

                    // Single day fallback (accepts multiple shapes)
                    let out = '';
                    const activities = data.activities?.summary || data.summary || {};
                    if (activities.steps) out += `Steps: ${activities.steps}\n`;
                    if (activities.caloriesOut) out += `Calories: ${activities.caloriesOut}\n`;
                    const fairly = activities.fairlyActiveMinutes || 0;
                    const very = activities.veryActiveMinutes || 0;
                    const activeTotal = fairly + very;
                    if (activeTotal) out += `Active Minutes: ${activeTotal} (Fairly: ${fairly}, Very: ${very})\n`;
                    const distances = activities.distances;
                    if (Array.isArray(distances) && distances[0]?.distance) out += `Distance: ${distances[0].distance} miles\n`;
                    if (activities.distance) out += `Distance: ${activities.distance} km\n`;
                    const rhr = data.heart?.['activities-heart']?.[0]?.value?.restingHeartRate || data.heart?.restingHeartRate;
                    if (rhr) out += `Resting HR: ${rhr}\n`;
                    const sleepMin = data.sleep?.summary?.totalMinutesAsleep || data.sleep?.totalMinutesAsleep;
                    const inBed = data.sleep?.summary?.totalTimeInBed || data.sleep?.totalTimeInBed;
                    if (sleepMin || inBed) out += `Sleep: ${sleepMin || 0} min asleep / ${inBed || 0} in bed\n`;
                    return out.trim() || 'Data parsed but no key metrics found.';
                } catch (e) {
                    return 'Failed to parse summary.';
                }
            }

            function buildUsageSynopsis(data) {
                if (!data) return '';
                try {
                    if (Array.isArray(data.days) && data.days.length) {
                        const days = data.days;
                        let totalSteps = 0, totalActive = 0, totalSleepMin = 0;
                        let rhrSum = 0, rhrCount = 0;
                        days.forEach(d => {
                            const s = d.activities?.summary || {};
                            totalSteps += s.steps || 0;
                            totalActive += (s.fairlyActiveMinutes || 0) + (s.veryActiveMinutes || 0);
                            const sm = d.sleep?.summary?.totalMinutesAsleep;
                            if (typeof sm === 'number') totalSleepMin += sm;
                            const rhr = d.heart?.['activities-heart']?.[0]?.value?.restingHeartRate;
                            if (typeof rhr === 'number') { rhrSum += rhr; rhrCount++; }
                        });
                        const avgSteps = Math.round(totalSteps / days.length).toLocaleString();
                        const avgActive = Math.round(totalActive / days.length);
                        const avgSleepHrs = (totalSleepMin / days.length / 60).toFixed(1);
                        const avgRHR = rhrCount ? Math.round(rhrSum / rhrCount) : null;
                        const latest = days[days.length - 1];
                        const latestSteps = (latest.activities?.summary?.steps || 0).toLocaleString();
                        return `Using 7-day dataset: ${days[0].date} → ${days[days.length - 1].date} • Avg steps ${avgSteps}/day • Avg active ${avgActive}/day • Avg sleep ${avgSleepHrs}h • Today ${latestSteps} steps${avgRHR ? ` • Avg RHR ${avgRHR}` : ''}`;
                    }
                    const steps = data.activities?.summary?.steps;
                    const fairly = data.activities?.summary?.fairlyActiveMinutes || 0;
                    const very = data.activities?.summary?.veryActiveMinutes || 0;
                    const sleepMin = data.sleep?.summary?.totalMinutesAsleep || data.sleep?.totalMinutesAsleep;
                    const sleepHrs = sleepMin ? (sleepMin / 60).toFixed(1) : null;
                    const date = data.date || new Date().toISOString().slice(0,10);
                    return `Using 1-day dataset: ${date} • Steps ${steps?.toLocaleString?.() || steps || 0} • Active ${fairly + very} •${sleepHrs ? ` Sleep ${sleepHrs}h` : ' Sleep n/a'}`;
                } catch { return ''; }
            }

            // (Buttons removed in favor of modal)

            function generateDummyFitbitData() { // 7-day dataset
                const randInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
                const toISODate = (d) => new Date(d.getTime() - d.getTimezoneOffset()*60000).toISOString().slice(0,10);
                const today = new Date();
                const days = [];
                for (let i = 6; i >= 0; i--) {
                    const dateObj = new Date(today);
                    dateObj.setDate(today.getDate() - i);
                    const date = toISODate(dateObj);
                    const steps = randInt(3500, 14000);
                    const fairly = randInt(10, 60);
                    const very = randInt(5, 45);
                    const activeTotal = fairly + very;
                    const caloriesOut = randInt(1700, 3200);
                    const miles = parseFloat((steps / 2000).toFixed(2));
                    const restingHeartRate = randInt(55, 75);
                    const totalMinutesAsleep = randInt(320, 520);
                    const totalTimeInBed = totalMinutesAsleep + randInt(10, 80);
                    const day = {
                        date,
                        activities: {
                            summary: {
                                steps,
                                caloriesOut,
                                fairlyActiveMinutes: fairly,
                                veryActiveMinutes: very,
                                distances: [{ activity: 'total', distance: miles }]
                            },
                            goals: { steps: 10000, activeMinutes: 30 }
                        },
                        heart: { 'activities-heart': [{ dateTime: date, value: { restingHeartRate } }] },
                        sleep: { summary: { totalMinutesAsleep, totalTimeInBed } }
                    };
                    days.push(day);
                }
                const latest = days[days.length - 1];
                return {
                    days,
                    weekStart: days[0].date,
                    weekEnd: days[days.length - 1].date,
                    // Expose latest day at top-level for compatibility with server prompt builder
                    activities: latest.activities,
                    heart: latest.heart,
                    sleep: latest.sleep
                };
            }

            function generateDummyDayData() { // 1-day dataset
                const randInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
                const date = new Date().toISOString().slice(0,10);
                const steps = randInt(3500, 14000);
                const fairly = randInt(10, 60);
                const very = randInt(5, 45);
                const caloriesOut = randInt(1700, 3200);
                const miles = parseFloat((steps / 2000).toFixed(2));
                const restingHeartRate = randInt(55, 75);
                const totalMinutesAsleep = randInt(320, 520);
                const totalTimeInBed = totalMinutesAsleep + randInt(10, 80);
                const activities = {
                    summary: {
                        steps,
                        caloriesOut,
                        fairlyActiveMinutes: fairly,
                        veryActiveMinutes: very,
                        distances: [{ activity: 'total', distance: miles }]
                    },
                    goals: { steps: 10000, activeMinutes: 30 }
                };
                const heart = { 'activities-heart': [{ dateTime: date, value: { restingHeartRate } }] };
                const sleep = { summary: { totalMinutesAsleep, totalTimeInBed } };
                return { activities, heart, sleep, date };
            }

            async function loadHistory() {
                try {
                    const res = await fetch('https://ai-health-tool-1.onrender.com/api/responses');
                    if (!res.ok) return;
                    const data = await res.json();
                    const items = data.items || [];
                    const container = document.getElementById('history-items');
                    if (!container) return;
                    container.innerHTML = '';
                    items.slice().reverse().forEach(r => {
                        const div = document.createElement('div');
                        div.style.padding = '10px';
                        div.style.background = '#f4f6f9';
                        div.style.borderRadius = '8px';
                        div.style.borderLeft = '4px solid #2a9d8f';
                        div.innerHTML = `<div style="font-size:0.7rem;color:#555;">${new Date(r.timestamp).toLocaleTimeString()}${r.rateLimited ? ' (rate limited)' : ''}</div><div style="font-size:0.8rem;font-weight:600;margin-bottom:4px;">Prompt: ${r.prompt ? r.prompt.replace(/</g,'&lt;') : '(generated)'}</div><div style="white-space:pre-wrap;font-size:0.85rem;">${(r.message||'').replace(/</g,'&lt;')}</div>`;
                        container.appendChild(div);
                    });
                    const histWrapper = document.getElementById('history');
                    if (items.length) histWrapper.style.display = 'block';
                } catch(e) { console.warn('History load failed', e); }
            }

            function renderDayCards(message) {
                const dayCardsEl = document.getElementById('day-cards');
                dayCardsEl.innerHTML = '';
                const dayRegex = /^(Monday|Tuesday|Wednesday|Thursday|Friday|Saturday|Sunday)\b.*$/mi;
                if (!dayRegex.test(message)) { dayCardsEl.style.display = 'none'; return; }
                const lines = message.split(/\n+/);
                const groups = [];
                let current = null;
                const dayNameRegex = /^(Monday|Tuesday|Wednesday|Thursday|Friday|Saturday|Sunday)\b/i;
                for (const line of lines) {
                    if (dayNameRegex.test(line)) {
                        if (current) groups.push(current);
                        current = { day: line.split(':')[0], content: line.replace(/^[^:]*:\s?/, '') };
                    } else if (current) {
                        current.content += '\n' + line;
                    }
                }
                if (current) groups.push(current);
                if (!groups.length) { dayCardsEl.style.display = 'none'; return; }
                groups.forEach(g => {
                    const card = document.createElement('div');
                    card.style.flex = '1 1 240px';
                    card.style.background = '#ffffff';
                    card.style.border = '1px solid #e0e0e0';
                    card.style.borderRadius = '10px';
                    card.style.padding = '12px';
                    card.style.boxShadow = '0 2px 4px rgba(0,0,0,0.08)';
                    card.innerHTML = `<div style="font-weight:600;color:#764ba2;margin-bottom:6px;">${g.day}</div><div style="white-space:pre-wrap;font-size:0.75rem;">${g.content.trim().replace(/</g,'&lt;')}</div>`;
                    dayCardsEl.appendChild(card);
                });
                dayCardsEl.style.display = 'flex';
            }

            submitBtn.addEventListener('click', async () => {
                const prompt = (promptInput.value || '').trim();
                if (!prompt) {
                    showError('Please enter a prompt first.');
                    return;
                }
                submitBtn.disabled = true;
                submitBtn.textContent = 'Thinking...';
                const originalSubmitText = 'Send Prompt';
                coachingResponse.style.display = 'none';
                errorSection.style.display = 'none';
                try {
                    try {
                        const qs = await fetch('https://ai-health-tool-1.onrender.com/api/queue/status');
                        if (qs.ok) {
                            const q = await qs.json();
                            if (q.queueDepth > 0) {
                                showError(`Queued, position ${q.queueDepth}. Processing soon...`);
                            }
                        }
                    } catch (_) {}
                    console.log('Sending coach request payload:', { prompt, demo: false });
                    const res = await fetch('https://ai-health-tool-1.onrender.com/api/coach', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt, demo: false, fitbitData: uploadedFitbitData })
                    });
                    if (!res.ok) {
                        const errorText = await res.text().catch(() => 'Unknown error');
                        console.error('API Error:', res.status, errorText);
                        if (res.status === 429 || errorText.includes('Too many requests')) {
                            throw new Error('Rate limited. Please wait a moment and try again.');
                        }
                        throw new Error(`Server error (${res.status}). Check Render logs.`);
                    }
                    const data = await res.json();
                    console.log('Coach response:', data);
                    if (typeof data.queuePosition === 'number' && data.queuePosition > 0) {
                        showError(`Request was queued (position ${data.queuePosition}).`);
                    }
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    const msg = data.message || 'No response from coach.';
                    // Show server-provided data synopsis above the message
                    const cdu = document.getElementById('coaching-data-usage');
                    const synopsis = data.dataSynopsis || buildUsageSynopsis(uploadedFitbitData);
                    if (cdu) {
                        cdu.textContent = synopsis || '';
                        cdu.style.display = synopsis ? 'block' : 'none';
                    }
                    coachingText.textContent = msg;
                    renderDayCards(msg);
                    coachingResponse.style.display = 'block';
                    await loadHistory();
                } catch (err) {
                    console.error('Coaching error:', err);
                    showError(err.message || 'Network error. Is Render sleeping?');
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalSubmitText;
                }
            });

            function showError(msg) {
                errorSection.style.display = 'block';
                errorMessage.textContent = msg;
                setTimeout(() => { errorSection.style.display = 'none'; }, 4000);
            }

            // Initial history load
            loadHistory();
        });
    </script>
</head>
<body>
    <div class="container" style="display: flex; gap: 32px; align-items: flex-start;">
        <div style="flex: 1; min-width: 320px;">
            <header>
                <h1>AI Health Coach</h1>
                <p>Welcome! Connect Fitbit and chat with the coach.</p>
            </header>

            <div class="card" id="auth-section">
                <h2>Connect Your Fitbit</h2>
                <p>Authorize via our hosted app or upload exported JSON for targeted coaching.</p>
                                <div style="display:flex; gap:12px; flex-wrap:wrap;">
                    <button id="connect-btn" class="btn btn-primary">Connect with Fitbit</button>
                                        <button id="upload-fitbit" class="btn btn-secondary">Upload Fitbit Data</button>
                    <input type="file" id="fitbit-file" accept="application/json" style="display:none;" />
                </div>
                <div id="fitbit-preview" style="display:none; margin-top:14px; background:#f4f6f9; border:1px solid #e0e0e0; padding:12px; border-radius:8px;">
                   <strong style="display:block; margin-bottom:6px;">Uploaded Data Summary:</strong>
                   <div id="fitbit-summary" style="font-size:0.85rem; white-space:pre-wrap;"></div>
                </div>
            </div>

                        <!-- Modal for data selection -->
                        <div id="fitbit-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.45); align-items:center; justify-content:center; z-index:1000;">
                            <div style="background:#fff; width:min(520px, 92vw); border-radius:12px; padding:20px; box-shadow:0 10px 30px rgba(0,0,0,0.2);">
                                <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:10px;">
                                    <h3 style="margin:0; color:#333;">Fitbit Data Options</h3>
                                    <button id="fitbit-modal-close" class="btn" style="background:#e9ecef; color:#333;">Close</button>
                                </div>
                                <p style="color:#555; margin-bottom:14px;">Choose how to provide data for better, personalized coaching.</p>
                                <div style="display:flex; flex-wrap:wrap; gap:10px;">
                                    <button id="fitbit-modal-upload" class="btn btn-secondary">Upload JSON File</button>
                                    <button id="fitbit-modal-generate-day" class="btn btn-secondary">Generate 1 Day</button>
                                    <button id="fitbit-modal-generate-week" class="btn btn-secondary">Generate 7 Days</button>
                                    <button id="fitbit-modal-load-sample" class="btn btn-secondary">Load Sample</button>
                                </div>
                            </div>
                        </div>

            <div class="card" id="llm-section">
                <h2>Ask the Coach</h2>
                <p>Type a prompt for the coach. Example: "Create a weekly workout plan"</p>
                <div id="config-warning" style="display:none; background: #fff3cd; border: 1px solid #ffc107; color: #856404; padding: 12px; border-radius: 6px; margin-bottom: 12px; font-size: 0.9em;">
                    <strong>Configuration issue:</strong> <span id="config-message"></span>
                </div>
                <textarea id="prompt-input" rows="4" placeholder="Enter your prompt..."></textarea>
                <div style="margin-top:12px;">
                    <button id="submit-prompt" class="btn btn-secondary">Send Prompt</button>
                    <button id="check-config" class="btn" style="background: #6c757d; color: white; margin-left: 8px;">Check Config</button>
                    <span id="config-status" style="margin-left: 10px; font-size: 0.9em; color: #555;"></span>
                </div>
                <div id="data-usage" style="display:none; margin-top:10px; font-size:0.9em; color:#2a9d8f; background:#e8f6f3; border:1px solid #bde5dc; padding:8px 10px; border-radius:6px;"></div>
                <div id="coaching-response" style="display:none; margin-top:16px;">
                    <div class="coaching-message">
                        <div class="message-header"><strong>Your Coach Says:</strong></div>
                        <div id="coaching-data-usage" style="display:none; margin:-4px 0 8px; font-size:0.85em; color:#2a6f6b; background:#e8f6f3; border:1px solid #bde5dc; padding:6px 8px; border-radius:6px;"></div>
                        <p id="coaching-text"></p>
                        <div id="day-cards" style="display:none; flex-wrap:wrap; gap:12px; margin-top:12px;"></div>
                    </div>
                </div>
                <div id="error-section" class="error-card" style="display:none;">
                    <h3>Error</h3>
                    <p id="error-message"></p>
                </div>
                <div id="history" class="card" style="display:none; margin-top:18px;">
                  <h3 style="margin-bottom:12px;">Recent Responses</h3>
                  <div id="history-items" style="display:flex; flex-direction:column; gap:10px;"></div>
                </div>
            </div>

            <footer>
                <p>Built with ❤️ for health and wellness</p>
            </footer>
        </div>
        <aside style="flex: 1; min-width: 280px; max-width: 400px;">
            <div class="card" style="background: #f8f9fa;">
                <h2 style="color: #764ba2;">About This App</h2>
                <p>
                    <strong>AI Health Coach</strong> is a modern web application that combines your Fitbit health data with the power of AI to deliver personalized, actionable health coaching. After connecting your Fitbit account, the app securely syncs your latest activity, heart rate, and sleep data. You can then interact with an AI coach by entering any health-related prompt—such as asking for a workout plan, nutrition advice, or motivation.
                </p>
                <p>
                    The AI analyzes your real Fitbit data and responds with tailored feedback, encouragement, and recommendations. Whether you want to improve your fitness, sleep better, or simply stay motivated, this tool provides instant, expert guidance. All data is processed securely, and you can use the app from any device.
                </p>
                <ul>
                    <li>Connects to Fitbit for real-time health data</li>
                    <li>Uses advanced AI models for coaching</li>
                    <li>Supports any health or fitness prompt</li>
                    <li>Works on desktop and mobile</li>
                </ul>
                <p style="margin-top: 12px; color: #555; font-size: 0.98em;">
                    <em>Your privacy is important: your Fitbit data is only used to generate coaching responses and is never shared.</em>
                </p>
            </div>
        </aside>
    </div>
</body>
</html>
