<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AI Health Coach</title>
    <style>
        /* ReactBits-inspired animated gradient background */
        body {
          min-height: 100vh;
          background: linear-gradient(120deg, #a1c4fd 0%, #c2e9fb 100%);
          background-size: 200% 200%;
          animation: gradientMove 12s ease-in-out infinite;
          margin: 0;
          padding: 0;
        }
        .container {
          max-width: 1200px;
          margin: 0 auto;
          padding: 32px 16px 48px 16px;
        }
        .main-flex {
          display: flex;
          gap: 40px;
          align-items: flex-start;
          justify-content: center;
        }
        .main-col {
          flex: 2 1 380px;
          min-width: 340px;
          max-width: 520px;
        }
        aside, #history-section {
          flex: 1 1 320px;
          min-width: 260px;
          max-width: 400px;
        }
        #history-section, aside .card {
          background: rgba(255,255,255,0.92);
          border-radius: 18px;
          box-shadow: 0 4px 24px 0 rgba(76,201,240,0.10), 0 1.5px 4px rgba(76,201,240,0.08);
          border: 1.5px solid rgba(120,120,180,0.10);
          margin-bottom: 32px;
          padding: 28px 24px 24px 24px;
        }
        #history-section h3 {
          margin-top: 0;
          margin-bottom: 18px;
        }
        .card, .coaching-message, #fitbit-preview, textarea {
          background: rgba(255,255,255,0.82);
          backdrop-filter: blur(8px) saturate(1.2);
          -webkit-backdrop-filter: blur(8px) saturate(1.2);
          border-radius: 16px;
          box-shadow: 0 6px 24px 0 rgba(76,201,240,0.10), 0 1.5px 4px rgba(76,201,240,0.08);
          margin-bottom: 32px;
        }
        .card {
          border: 1.5px solid rgba(120,120,180,0.08);
          padding: 32px 28px;
        }
        header {
          text-align: center;
          color: white;
          margin-bottom: 40px;
          padding: 32px 0 24px 0;
          box-shadow: 0 8px 32px 0 rgba(76,201,240,0.10);
        }
        header h1 {
          font-size: 2.8rem;
          margin-bottom: 12px;
          letter-spacing: 0.01em;
        }
        .subtitle {
          font-size: 1.2rem;
          margin-bottom: 0;
        }
        .btn, .btn-primary, .btn-secondary {
          background: linear-gradient(90deg, #43e97b 0%, #38f9d7 100%);
          color: #1a1a2e;
          border: none;
          border-radius: 12px;
          font-weight: 700;
          font-size: 1.18rem;
          padding: 18px 36px;
          min-width: 120px;
          min-height: 48px;
          box-shadow: 0 2px 8px rgba(67,233,123,0.08);
          transition: box-shadow 0.2s, transform 0.2s;
          margin-right: 10px;
        }
        .btn:last-child { margin-right: 0; }
        .btn:hover, .btn:focus {
          box-shadow: 0 6px 18px rgba(67,233,123,0.18);
          transform: translateY(-2px) scale(1.03);
        }
        textarea {
          color: #222;
          font-size: 1.08rem;
          border: 1.5px solid #b2c2e0;
          margin-top: 8px;
          margin-bottom: 8px;
          box-shadow: 0 2px 8px rgba(120,120,180,0.04);
          padding: 16px 14px;
        }
        textarea:focus {
          border-color: #4cc9f0;
          background: rgba(255,255,255,0.95);
        }
        .badge {
          display: inline-block;
          background: linear-gradient(90deg, #00b0b9 60%, #4cc9f0 100%);
          color: white;
          font-size: 0.95rem;
          font-weight: 700;
          border-radius: 6px;
          padding: 4px 12px;
          margin-left: 10px;
          letter-spacing: 0.04em;
          box-shadow: 0 2px 8px rgba(0,176,185,0.10);
          vertical-align: middle;
          animation: badgePop 0.7s cubic-bezier(.68,-0.55,.27,1.55);
        }
        @keyframes badgePop {
          0% { transform: scale(0.7); opacity: 0; }
          60% { transform: scale(1.15); opacity: 1; }
          100% { transform: scale(1); }
        }
        .loader {
          display: inline-block;
          width: 22px;
          height: 22px;
          border: 3px solid #e0e0e0;
          border-top: 3px solid #00b0b9;
          border-radius: 50%;
          animation: spin 0.7s linear infinite;
          margin-left: 10px;
          vertical-align: middle;
        }
        @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }
        /* Dark mode styles - now covers all cards/sections */
        body.dark {
          background: linear-gradient(120deg, #232946 0%, #16161a 100%);
          color: #f4f4f4;
        }
        body.dark .container, body.dark .main-flex {
          background: none;
        }
        body.dark .card, body.dark .coaching-message, body.dark #fitbit-preview, body.dark textarea, body.dark aside .card, body.dark #history-section {
          background: rgba(30,34,54,0.96) !important;
          color: #f4f4f4 !important;
          border: 1.5px solid #232946;
          box-shadow: 0 4px 24px 0 rgba(76,201,240,0.18), 0 1.5px 4px rgba(76,201,240,0.12);
        }
        body.dark .btn, body.dark .btn-primary, body.dark .btn-secondary {
          background: linear-gradient(90deg, #232946 0%, #4cc9f0 100%);
          color: #f4f4f4;
        }
        body.dark header h1, body.dark .card h2, body.dark .card h3 {
          color: #a1c4fd;
        }
        body.dark .subtitle, body.dark .card p, body.dark .card li, body.dark .coaching-message, body.dark #fitbit-preview, body.dark aside .card, body.dark #history-section {
          color: #e0e0e0 !important;
        }
        body.dark .badge {
          background: linear-gradient(90deg, #4cc9f0 60%, #232946 100%);
          color: #232946;
        }
        body.dark .error-card {
          background: #2d1e2f;
          color: #ffb4b4;
        }
        @media (max-width: 900px) {
          .main-flex { flex-direction: column; gap: 0; }
          aside, #history-section, .main-col { max-width: 100%; min-width: 0; }
        }
    </style>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const connectBtn = document.getElementById('connect-btn');
            const uploadBtn = document.getElementById('upload-fitbit');
            const fitbitFileInput = document.getElementById('fitbitFileInput');
            const fitbitPreview = document.getElementById('fitbit-preview');
            const fitbitSummary = document.getElementById('fitbit-summary');
            let uploadedFitbitData = null;
            const submitBtn = document.getElementById('submitBtn');
            const promptInput = document.getElementById('user-input');
            const errorSection = document.getElementById('error-message');
            const errorMessage = document.getElementById('error-message');
            const coachingResponse = document.getElementById('response');
            const coachingText = document.getElementById('response');
            const checkConfigBtn = document.getElementById('check-config');
            // Modal elements
            const modal = document.getElementById('fitbit-modal');
            const modalClose = document.getElementById('fitbit-modal-close');
            const modalUpload = document.getElementById('fitbit-modal-upload');
            const modalGenDay = document.getElementById('fitbit-modal-generate-day');
            const modalGenWeek = document.getElementById('fitbit-modal-generate-week');
            const modalLoadSample = document.getElementById('fitbit-modal-load-sample');
            const configWarning = document.getElementById('config-warning');
            const configMessage = document.getElementById('config-message');

            // API base URL for GitHub Pages deployment
            const API_BASE_URL = 'https://ai-health-tool-1.onrender.com';

            // Check configuration on page load
            checkConfig();
            async function checkConfig() {
                try {
                    const res = await fetch(`${API_BASE_URL}/health`, { credentials: 'include' });
                    if (res.ok) {
                        const data = await res.json();
                        if (data.llmConfigured) {
                            configWarning.style.display = 'none';
                        } else {
                            configWarning.style.display = 'block';
                            configMessage.textContent = 'Backend connected, but LLM not configured. Set GITHUB_TOKEN on Render.';
                        }
                    } else {
                        throw new Error('Backend unreachable');
                    }
                } catch (err) {
                    configWarning.style.display = 'block';
                    configMessage.textContent = `Backend connection issue: ${err.message}. Ensure Render app is running.`;
                }
            }

            checkConfigBtn.addEventListener('click', () => {
                checkConfig();
            });

            connectBtn.addEventListener('click', () => {
                window.location.href = `${API_BASE_URL}/auth/fitbit`;
            });

            uploadBtn.addEventListener('click', () => {
                openModal();
            });

            function openModal() {
                if (!modal) return;
                modal.style.display = 'flex';
            }
            function closeModal() {
                if (!modal) return;
                modal.style.display = 'none';
            }
            if (modalClose) modalClose.addEventListener('click', closeModal);
            window.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') closeModal();
            });
            if (modal) modal.addEventListener('click', (e) => {
                if (e.target === modal) closeModal();
            });

            // Modal actions
            if (modalUpload) modalUpload.addEventListener('click', () => {
                fitbitFileInput.click();
            });
            if (modalGenDay) modalGenDay.addEventListener('click', () => {
                const data = generateDummyDayData();
                handleDataSelection(data, '1-day dummy data loaded.');
            });
            if (modalGenWeek) modalGenWeek.addEventListener('click', () => {
                const data = generateDummyFitbitData();
                handleDataSelection(data, '7-day dummy data loaded.');
            });
            if (modalLoadSample) modalLoadSample.addEventListener('click', async () => {
                try {
                    const res = await fetch('sample-fitbit.json');
                    if (!res.ok) throw new Error('HTTP ' + res.status);
                    const json = await res.json();
                    handleDataSelection(json, 'Sample Fitbit data loaded.');
                } catch (e) {
                    showError('Could not load sample data.');
                }
            });

            function handleDataSelection(json, successMsg) {
              uploadedFitbitData = json;
              const summary = buildFitbitSummary(json);
              if (summary && summary !== 'No data loaded.' && summary !== 'Failed to parse summary.') {
                fitbitSummary.textContent = summary;
                fitbitSummary.style.display = 'block';
                fitbitPreview.style.display = 'block';
              } else {
                fitbitSummary.textContent = '';
                fitbitSummary.style.display = 'none';
                fitbitPreview.style.display = 'none';
              }
              const synopsis = buildUsageSynopsis(json);
              const usage = document.getElementById('data-usage');
              if (usage) {
                usage.textContent = synopsis;
                usage.style.display = synopsis ? 'block' : 'none';
              }
              closeModal();
              // Show a visual confirmation for dummy/sample data
              if (successMsg) {
                fitbitSummary.textContent += `\n${successMsg}`;
                fitbitSummary.style.display = 'block';
              }
            }

            if (fitbitFileInput) {
              fitbitFileInput.addEventListener('change', async (e) => {
                const file = e.target.files && e.target.files[0];
                if (!file) return;
                try {
                  const text = await file.text();
                  const json = JSON.parse(text);
                  handleDataSelection(json, 'File loaded.');
                } catch (err) {
                  showError('Invalid JSON file');
                  uploadedFitbitData = null;
                  fitbitPreview.style.display = 'none';
                  const usage = document.getElementById('data-usage');
                  if (usage) usage.style.display = 'none';
                }
              });
            }

            function buildFitbitSummary(data) {
                if (!data) return 'No data loaded.';
                try {
                    // Weekly dataset support: data.days = [ { date, activities, heart, sleep } ]
                    if (Array.isArray(data.days) && data.days.length) {
                        const days = data.days;
                        let totalSteps = 0, totalActive = 0, totalSleepMin = 0;
                        let rhrSum = 0, rhrCount = 0;
                        days.forEach(d => {
                            const s = d.activities?.summary || {};
                            totalSteps += s.steps || 0;
                            totalActive += (s.fairlyActiveMinutes || 0) + (s.veryActiveMinutes || 0);
                            const sm = d.sleep?.summary?.totalMinutesAsleep;
                            if (typeof sm === 'number') totalSleepMin += sm;
                            const rhr = d.heart?.['activities-heart']?.[0]?.value?.restingHeartRate;
                            if (typeof rhr === 'number') { rhrSum += rhr; rhrCount++; }
                        });
                        const avgSteps = Math.round(totalSteps / days.length).toLocaleString();
                        const avgActive = Math.round(totalActive / days.length);
                        const avgSleepHrs = (totalSleepMin / days.length / 60).toFixed(1);
                        const avgRHR = rhrCount ? Math.round(rhrSum / rhrCount) : null;
                        const latest = days[days.length - 1];
                        const latestSteps = (latest.activities?.summary?.steps || 0).toLocaleString();
                        return `Using 7-day dataset: ${days[0].date} â†’ ${days[days.length - 1].date} â€¢ Avg steps ${avgSteps}/day â€¢ Avg active ${avgActive}/day â€¢ Avg sleep ${avgSleepHrs}h â€¢ Today ${latestSteps} steps${avgRHR ? ` â€¢ Avg RHR ${avgRHR}` : ''}`;
                    }

                    // Single day fallback (accepts multiple shapes)
                    let out = '';
                    const activities = data.activities?.summary || data.summary || {};
                    if (activities.steps) out += `Steps: ${activities.steps}\n`;
                    if (activities.caloriesOut) out += `Calories: ${activities.caloriesOut}\n`;
                    const fairly = activities.fairlyActiveMinutes || 0;
                    const very = activities.veryActiveMinutes || 0;
                    const activeTotal = fairly + very;
                    if (activeTotal) out += `Active Minutes: ${activeTotal} (Fairly: ${fairly}, Very: ${very})\n`;
                    const distances = activities.distances;
                    if (Array.isArray(distances) && distances[0]?.distance) out += `Distance: ${distances[0].distance} miles\n`;
                    if (activities.distance) out += `Distance: ${activities.distance} km\n`;
                    const rhr = data.heart?.['activities-heart']?.[0]?.value?.restingHeartRate || data.heart?.restingHeartRate;
                    if (rhr) out += `Resting HR: ${rhr}\n`;
                    const sleepMin = data.sleep?.summary?.totalMinutesAsleep || data.sleep?.totalMinutesAsleep;
                    const inBed = data.sleep?.summary?.totalTimeInBed || data.sleep?.totalTimeInBed;
                    if (sleepMin || inBed) out += `Sleep: ${sleepMin || 0} min asleep / ${inBed || 0} in bed\n`;
                    return out.trim() || 'Data parsed but no key metrics found.';
                } catch (e) {
                    return 'Failed to parse summary.';
                }
            }

            function buildUsageSynopsis(data) {
                if (!data) return '';
                try {
                    if (Array.isArray(data.days) && data.days.length) {
                        const days = data.days;
                        let totalSteps = 0, totalActive = 0, totalSleepMin = 0;
                        let rhrSum = 0, rhrCount = 0;
                        days.forEach(d => {
                            const s = d.activities?.summary || {};
                            totalSteps += s.steps || 0;
                            totalActive += (s.fairlyActiveMinutes || 0) + (s.veryActiveMinutes || 0);
                            const sm = d.sleep?.summary?.totalMinutesAsleep;
                            if (typeof sm === 'number') totalSleepMin += sm;
                            const rhr = d.heart?.['activities-heart']?.[0]?.value?.restingHeartRate;
                            if (typeof rhr === 'number') { rhrSum += rhr; rhrCount++; }
                        });
                        const avgSteps = Math.round(totalSteps / days.length).toLocaleString();
                        const avgActive = Math.round(totalActive / days.length);
                        const avgSleepHrs = (totalSleepMin / days.length / 60).toFixed(1);
                        const avgRHR = rhrCount ? Math.round(rhrSum / rhrCount) : null;
                        const latest = days[days.length - 1];
                        const latestSteps = (latest.activities?.summary?.steps || 0).toLocaleString();
                        return `Using 7-day dataset: ${days[0].date} â†’ ${days[days.length - 1].date} â€¢ Avg steps ${avgSteps}/day â€¢ Avg active ${avgActive}/day â€¢ Avg sleep ${avgSleepHrs}h â€¢ Today ${latestSteps} steps${avgRHR ? ` â€¢ Avg RHR ${avgRHR}` : ''}`;
                    }
                    const steps = data.activities?.summary?.steps;
                    const fairly = data.activities?.summary?.fairlyActiveMinutes || 0;
                    const very = data.activities?.summary?.veryActiveMinutes || 0;
                    const sleepMin = data.sleep?.summary?.totalMinutesAsleep || data.sleep?.totalMinutesAsleep;
                    const sleepHrs = sleepMin ? (sleepMin / 60).toFixed(1) : null;
                    const date = data.date || new Date().toISOString().slice(0,10);
                    return `Using 1-day dataset: ${date} â€¢ Steps ${steps?.toLocaleString?.() || steps || 0} â€¢ Active ${fairly + very} â€¢${sleepHrs ? ` Sleep ${sleepHrs}h` : ' Sleep n/a'}`;
                } catch { return ''; }
            }

            // (Buttons removed in favor of modal)

            function generateDummyFitbitData() { // 7-day dataset
                const randInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
                const toISODate = (d) => new Date(d.getTime() - d.getTimezoneOffset()*60000).toISOString().slice(0,10);
                const today = new Date();
                const days = [];
                for (let i = 6; i >= 0; i--) {
                    const dateObj = new Date(today);
                    dateObj.setDate(today.getDate() - i);
                    const date = toISODate(dateObj);
                    const steps = randInt(3500, 14000);
                    const fairly = randInt(10, 60);
                    const very = randInt(5, 45);
                    const activeTotal = fairly + very;
                    const caloriesOut = randInt(1700, 3200);
                    const miles = parseFloat((steps / 2000).toFixed(2));
                    const restingHeartRate = randInt(55, 75);
                    const totalMinutesAsleep = randInt(320, 520);
                    const totalTimeInBed = totalMinutesAsleep + randInt(10, 80);
                    const day = {
                        date,
                        activities: {
                            summary: {
                                steps,
                                caloriesOut,
                                fairlyActiveMinutes: fairly,
                                veryActiveMinutes: very,
                                distances: [{ activity: 'total', distance: miles }]
                            },
                            goals: { steps: 10000, activeMinutes: 30 }
                        },
                        heart: { 'activities-heart': [{ dateTime: date, value: { restingHeartRate } }] },
                        sleep: { summary: { totalMinutesAsleep, totalTimeInBed } }
                    };
                    days.push(day);
                }
                const latest = days[days.length - 1];
                return {
                    days,
                    weekStart: days[0].date,
                    weekEnd: days[days.length - 1].date,
                    // Expose latest day at top-level for compatibility with server prompt builder
                    activities: latest.activities,
                    heart: latest.heart,
                    sleep: latest.sleep
                };
            }

            function generateDummyDayData() { // 1-day dataset
                const randInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
                const date = new Date().toISOString().slice(0,10);
                const steps = randInt(3500, 14000);
                const fairly = randInt(10, 60);
                const very = randInt(5, 45);
                const caloriesOut = randInt(1700, 3200);
                const miles = parseFloat((steps / 2000).toFixed(2));
                const restingHeartRate = randInt(55, 75);
                const totalMinutesAsleep = randInt(320, 520);
                const totalTimeInBed = totalMinutesAsleep + randInt(10, 80);
                const activities = {
                    summary: {
                        steps,
                        caloriesOut,
                        fairlyActiveMinutes: fairly,
                        veryActiveMinutes: very,
                        distances: [{ activity: 'total', distance: miles }]
                    },
                    goals: { steps: 10000, activeMinutes: 30 }
                };
                const heart = { 'activities-heart': [{ dateTime: date, value: { restingHeartRate } }] };
                const sleep = { summary: { totalMinutesAsleep, totalTimeInBed } };
                return { activities, heart, sleep, date };
            }

            async function loadHistory() {
                try {
                    const res = await fetch('https://ai-health-tool-1.onrender.com/api/history', { credentials: 'include' });
                    if (!res.ok) return;
                    const data = await res.json();
                    renderHistory(data.history || []);
                } catch (err) {
                    console.log('History unavailable:', err.message);
                }
            }

            function renderDayCards(message) {
                const dayCardsEl = document.getElementById('day-cards');
                dayCardsEl.innerHTML = '';
                const dayRegex = /^(Monday|Tuesday|Wednesday|Thursday|Friday|Saturday|Sunday)\b.*$/mi;
                if (!dayRegex.test(message)) { dayCardsEl.style.display = 'none'; return; }
                const lines = message.split(/\n+/);
                const groups = [];
                let current = null;
                const dayNameRegex = /^(Monday|Tuesday|Wednesday|Thursday|Friday|Saturday|Sunday)\b/i;
                for (const line of lines) {
                    if (dayNameRegex.test(line)) {
                        if (current) groups.push(current);
                        current = { day: line.split(':')[0], content: line.replace(/^[^:]*:\s?/, '') };
                    } else if (current) {
                        current.content += '\n' + line;
                    }
                }
                if (current) groups.push(current);
                if (!groups.length) { dayCardsEl.style.display = 'none'; return; }
                groups.forEach(g => {
                    const card = document.createElement('div');
                    card.style.flex = '1 1 240px';
                    card.style.background = '#ffffff';
                    card.style.border = '1px solid #e0e0e0';
                    card.style.borderRadius = '10px';
                    card.style.padding = '12px';
                    card.style.boxShadow = '0 2px 4px rgba(0,0,0,0.08)';
                    card.innerHTML = `<div style="font-weight:600;color:#764ba2;margin-bottom:6px;">${g.day}</div><div style="white-space:pre-wrap;font-size:0.75rem;">${g.content.trim().replace(/</g,'&lt;')}</div>`;
                    dayCardsEl.appendChild(card);
                });
                dayCardsEl.style.display = 'flex';
            }

            function renderHistory(historyArr) {
                // Find or create a history section
                let hist = document.getElementById('history-section');
                if (!hist) {
                    hist = document.createElement('div');
                    hist.id = 'history-section';
                    hist.className = 'card';
                    hist.style.marginTop = '18px';
                    document.querySelector('.container').appendChild(hist);
                }
                if (!Array.isArray(historyArr) || !historyArr.length) {
                    hist.innerHTML = '<div style="color:#888">No history yet.</div>';
                    return;
                }
                hist.innerHTML = '<h3 style="margin-bottom:10px;">Recent Coaching History</h3>' +
                    historyArr.slice(0, 10).map(item =>
                        `<div style="margin-bottom:10px; padding-bottom:8px; border-bottom:1px solid #eee;">
                            <div style="font-size:0.95em;color:#555;"><b>Prompt:</b> ${item.prompt || ''}</div>
                            <div style="font-size:0.95em;color:#2a9d8f;"><b>Message:</b> ${item.message || ''}</div>
                            <div style="font-size:0.85em;color:#888;">${item.timestamp ? new Date(item.timestamp).toLocaleString() : ''}</div>
                        </div>`
                    ).join('');
            }

            submitBtn.addEventListener('click', async () => {
                const prompt = (promptInput.value || '').trim();
                if (!prompt && !uploadedFitbitData) {
                    showError('Enter a prompt or upload Fitbit data.');
                    return;
                }

                submitBtn.disabled = true;
                submitBtn.textContent = 'Thinking...';
                coachingResponse.style.display = 'none';
                errorSection.style.display = 'none';

                try {
                    const body = { prompt };
                    if (uploadedFitbitData) body.fitbitData = uploadedFitbitData;
                    
                    const res = await fetch(`https://ai-health-tool-1.onrender.com/api/coach`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify(body)
                    });

                    if (!res.ok) {
                        const errorText = await res.text().catch(() => 'Unknown error');
                        if (res.status === 429) throw new Error('Rate limited. Wait and retry.');
                        try {
                            const errorData = JSON.parse(errorText);
                            throw new Error(errorData.message || `Server error (${res.status})`);
                        } catch {
                            throw new Error(`Server error (${res.status})`);
                        }
                    }

                    const data = await res.json();
                    if (data.error) throw new Error(data.error);
                    
                    coachingText.textContent = data.message || 'No response.';
                    coachingResponse.style.display = 'block';
                    renderDayCards(data.message || '');
                    loadHistory();
                } catch (err) {
                    showError(err.message || 'Network error');
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Send Prompt';
                }
            });

            function showError(msg) {
                errorSection.style.display = 'block';
                errorMessage.textContent = msg;
                setTimeout(() => { errorSection.style.display = 'none'; }, 4000);
            }

            // Dark mode toggle
            const darkModeToggle = document.getElementById('darkModeToggle');
            function setDarkMode(on) {
              document.body.classList.toggle('dark', on);
              localStorage.setItem('darkMode', on ? '1' : '0');
              if (darkModeToggle) darkModeToggle.textContent = on ? 'â˜€ï¸ Light Mode' : 'ðŸŒ™ Dark Mode';
            }
            if (darkModeToggle) {
              darkModeToggle.onclick = () => setDarkMode(!document.body.classList.contains('dark'));
              // On load, set from localStorage
              if (localStorage.getItem('darkMode') === '1') setDarkMode(true);
            }

            // Initial history load
            loadHistory();
        });
    </script>
</head>
<body>
  <div class="container">
    <header>
      <h1>AI Health Coach <span class="badge">Beta</span></h1>
      <div class="subtitle">Personalized wellness guidance powered by AI</div>
      <button id="darkModeToggle" class="btn" style="margin-top: 18px;">Toggle Dark Mode</button>
    </header>
    <div class="main-flex">
      <div class="main-col">
        <div id="config-warning" class="card" style="display:none; background:#fffbe6; color:#b8860b; border:1.5px solid #ffe58f; margin-bottom:24px;">
          <span id="config-message">Backend status unknown.</span>
          <button id="check-config" class="btn btn-secondary" style="margin-left:18px; min-width:90px; padding:8px 18px; font-size:0.98em;">Retry</button>
        </div>
        <div class="card">
          <h2>About This App</h2>
          <p>This AI Health Coach provides personalized wellness advice based on your input and fitness data. All data is processed securely in your browser. <br><br> Try asking for a daily health tip, nutrition advice, or a workout plan!</p>
        </div>
        <div class="card">
          <h3>Get Coaching</h3>
          <form id="coach-form">
            <textarea id="user-input" rows="4" placeholder="How can I help you today?"></textarea>
            <div style="margin-top: 18px;">
              <button type="submit" class="btn btn-primary" id="submitBtn">Ask Coach</button>
              <button type="button" class="btn btn-secondary" id="clear-btn">Clear</button>
            </div>
          </form>
          <div style="margin-top: 22px; margin-bottom: 8px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">
            <button type="button" class="btn btn-secondary" id="connect-btn">Connect Fitbit</button>
            <button type="button" class="btn btn-secondary" id="upload-fitbit">Upload Fitbit JSON</button>
            <button type="button" class="btn btn-secondary" id="fitbit-modal-generate-day">Dummy 1-Day</button>
            <button type="button" class="btn btn-secondary" id="fitbit-modal-generate-week">Dummy 7-Day</button>
            <button type="button" class="btn btn-secondary" id="fitbit-modal-load-sample">Sample Data</button>
          </div>
          <div id="fitbit-summary" style="display:none; margin: 10px 0 0 0; font-size:1.05em; color:#2a9d8f;"></div>
          </div>
        </div>
        <div id="fitbit-preview" class="card" style="display:none;"></div>
        <div id="response" class="coaching-message"></div>
        <input type="file" id="fitbitFileInput" accept="application/json" style="display:none;" />
      </div>
      <aside>
        <div id="history-section" class="card">
          <h3>Recent Coaching History</h3>
          <ul id="history-list" style="padding-left: 1.2em; margin: 0;"></ul>
        </div>
        <div class="card error-card" id="error-message" style="display:none;"></div>
      </aside>
    </div>
  </div>
  <script>
    // ...existing code...
    // Defensive event listener attachment for optional elements
    document.addEventListener('DOMContentLoaded', () => {
      const checkConfigBtn = document.getElementById('check-config');
      if (checkConfigBtn) checkConfigBtn.addEventListener('click', () => {
        if (typeof checkConfig === 'function') checkConfig();
      });
      const connectBtn = document.getElementById('connect-btn');
      if (connectBtn) connectBtn.addEventListener('click', () => {
        if (typeof API_BASE_URL !== 'undefined') {
          window.location.href = `${API_BASE_URL}/auth/fitbit`;
        }
      });
      const uploadBtn = document.getElementById('upload-fitbit');
      if (uploadBtn) uploadBtn.addEventListener('click', () => {
        if (typeof openModal === 'function') openModal();
      });

      // Ensure fitbitFileInput event listener is attached after DOM is ready
      const fitbitFileInput = document.getElementById('fitbitFileInput');
      if (fitbitFileInput) {
        fitbitFileInput.addEventListener('change', async (e) => {
          const file = e.target.files && e.target.files[0];
          if (!file) return;
          try {
            const text = await file.text();
            const json = JSON.parse(text);
            handleDataSelection(json, 'File loaded.');
          } catch (err) {
            showError('Invalid JSON file');
            uploadedFitbitData = null;
            fitbitPreview.style.display = 'none';
            const usage = document.getElementById('data-usage');
            if (usage) usage.style.display = 'none';
          }
        });
      }
    });
  </script>
</body>
</html>
