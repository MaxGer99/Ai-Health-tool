<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AI Health Coach</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 24px; color: #1a1a2e; }
        .container { max-width: 900px; margin: 0 auto; }
        header { text-align: center; color: white; margin-bottom: 30px; padding: 20px; }
        header h1 { font-size: 2.4rem; margin-bottom: 10px; }
        .card { background: white; border-radius: 12px; padding: 24px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .btn { padding: 12px 20px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; }
        .btn-primary { background: linear-gradient(135deg, #00b0b9, #4cc9f0); color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        textarea { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #e0e0e0; font-size: 1rem; resize: vertical; }
        .message-header { color: #2a9d8f; margin-bottom: 10px; font-size: 0.95rem; }
        .coaching-message { margin-top: 16px; padding: 16px; background: #fff; border-radius: 8px; border-left: 4px solid #2a9d8f; }
        .error-card { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; padding: 16px; border-radius: 8px; margin-top: 16px; }
        footer { text-align: center; color: white; margin-top: 24px; opacity: 0.85; }
    </style>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const connectBtn = document.getElementById('connect-btn');
            const submitBtn = document.getElementById('submit-prompt');
            const promptInput = document.getElementById('prompt-input');
            const errorSection = document.getElementById('error-section');
            const errorMessage = document.getElementById('error-message');
            const coachingResponse = document.getElementById('coaching-response');
            const coachingText = document.getElementById('coaching-text');
            const checkConfigBtn = document.getElementById('check-config');
            const configWarning = document.getElementById('config-warning');
            const configMessage = document.getElementById('config-message');

            // Check configuration on page load
            checkConfig();

            async function checkConfig() {
                // Visual feedback while checking
                if (checkConfigBtn) {
                    checkConfigBtn.disabled = true;
                    const originalText = checkConfigBtn.textContent;
                    checkConfigBtn.textContent = 'Checking...';
                    // restore after check completes
                    var restoreText = () => { checkConfigBtn.disabled = false; checkConfigBtn.textContent = originalText; };
                }
                try {
                    const res = await fetch('https://ai-health-tool-1.onrender.com/health');
                    const data = await res.json();
                    console.log('Health config:', data);
                    
                    if (!data.llmConfigured) {
                        configWarning.style.display = 'block';
                        configMessage.textContent = 'LLM not configured on Render. Set GITHUB_TOKEN, LLM_API_URL, and LLM_MODEL in environment variables, then redeploy.';
                        const s = document.getElementById('config-status');
                        if (s) s.textContent = `Last check: ${new Date().toLocaleTimeString()} • LLM not configured`;
                    } else if (!data.hasGithubToken) {
                        configWarning.style.display = 'block';
                        configMessage.textContent = 'GitHub token missing. Add GITHUB_TOKEN to Render environment.';
                        const s = document.getElementById('config-status');
                        if (s) s.textContent = `Last check: ${new Date().toLocaleTimeString()} • Token missing`;
                    } else {
                        configWarning.style.display = 'none';
                        // Provide success feedback
                        showError('✅ Configuration looks good.');
                        const s = document.getElementById('config-status');
                        if (s) s.textContent = `Last check: ${new Date().toLocaleTimeString()} • OK`;
                    }
                } catch (err) {
                    console.error('Could not check config:', err);
                    configWarning.style.display = 'block';
                    configMessage.textContent = 'Unable to reach health endpoint. Render may be sleeping or CORS blocked.';
                    const s = document.getElementById('config-status');
                    if (s) s.textContent = `Last check: ${new Date().toLocaleTimeString()} • Error`;
                }
                if (typeof restoreText === 'function') restoreText();
            }

            checkConfigBtn.addEventListener('click', checkConfig);

            connectBtn.addEventListener('click', () => {
                window.location.href = 'https://ai-health-tool-1.onrender.com/';
            });

            async function loadHistory() {
                try {
                    const res = await fetch('https://ai-health-tool-1.onrender.com/api/responses');
                    if (!res.ok) return;
                    const data = await res.json();
                    const items = data.items || [];
                    const container = document.getElementById('history-items');
                    if (!container) return;
                    container.innerHTML = '';
                    items.slice().reverse().forEach(r => {
                        const div = document.createElement('div');
                        div.style.padding = '10px';
                        div.style.background = '#f4f6f9';
                        div.style.borderRadius = '8px';
                        div.style.borderLeft = '4px solid #2a9d8f';
                        div.innerHTML = `<div style="font-size:0.7rem;color:#555;">${new Date(r.timestamp).toLocaleTimeString()}${r.rateLimited ? ' (rate limited)' : ''}</div><div style="font-size:0.8rem;font-weight:600;margin-bottom:4px;">Prompt: ${r.prompt ? r.prompt.replace(/</g,'&lt;') : '(generated)'}</div><div style="white-space:pre-wrap;font-size:0.85rem;">${(r.message||'').replace(/</g,'&lt;')}</div>`;
                        container.appendChild(div);
                    });
                    const histWrapper = document.getElementById('history');
                    if (items.length) histWrapper.style.display = 'block';
                } catch(e) { console.warn('History load failed', e); }
            }

            function renderDayCards(message) {
                const dayCardsEl = document.getElementById('day-cards');
                dayCardsEl.innerHTML = '';
                const dayRegex = /^(Monday|Tuesday|Wednesday|Thursday|Friday|Saturday|Sunday)\b.*$/mi;
                if (!dayRegex.test(message)) { dayCardsEl.style.display = 'none'; return; }
                const lines = message.split(/\n+/);
                const groups = [];
                let current = null;
                const dayNameRegex = /^(Monday|Tuesday|Wednesday|Thursday|Friday|Saturday|Sunday)\b/i;
                for (const line of lines) {
                    if (dayNameRegex.test(line)) {
                        if (current) groups.push(current);
                        current = { day: line.split(':')[0], content: line.replace(/^[^:]*:\s?/, '') };
                    } else if (current) {
                        current.content += '\n' + line;
                    }
                }
                if (current) groups.push(current);
                if (!groups.length) { dayCardsEl.style.display = 'none'; return; }
                groups.forEach(g => {
                    const card = document.createElement('div');
                    card.style.flex = '1 1 240px';
                    card.style.background = '#ffffff';
                    card.style.border = '1px solid #e0e0e0';
                    card.style.borderRadius = '10px';
                    card.style.padding = '12px';
                    card.style.boxShadow = '0 2px 4px rgba(0,0,0,0.08)';
                    card.innerHTML = `<div style="font-weight:600;color:#764ba2;margin-bottom:6px;">${g.day}</div><div style="white-space:pre-wrap;font-size:0.75rem;">${g.content.trim().replace(/</g,'&lt;')}</div>`;
                    dayCardsEl.appendChild(card);
                });
                dayCardsEl.style.display = 'flex';
            }

            submitBtn.addEventListener('click', async () => {
                const prompt = (promptInput.value || '').trim();
                if (!prompt) {
                    showError('Please enter a prompt first.');
                    return;
                }
                submitBtn.disabled = true;
                submitBtn.textContent = '⏳ Thinking...';
                const originalSubmitText = 'Send Prompt';
                coachingResponse.style.display = 'none';
                errorSection.style.display = 'none';
                try {
                    try {
                        const qs = await fetch('https://ai-health-tool-1.onrender.com/api/queue/status');
                        if (qs.ok) {
                            const q = await qs.json();
                            if (q.queueDepth > 0) {
                                showError(`Queued, position ${q.queueDepth}. Processing soon...`);
                            }
                        }
                    } catch (_) {}
                    console.log('Sending coach request payload:', { prompt, demo: false });
                    const res = await fetch('https://ai-health-tool-1.onrender.com/api/coach', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt, demo: false })
                    });
                    if (!res.ok) {
                        const errorText = await res.text().catch(() => 'Unknown error');
                        console.error('API Error:', res.status, errorText);
                        if (res.status === 429 || errorText.includes('Too many requests')) {
                            throw new Error('Rate limited. Please wait a moment and try again.');
                        }
                        throw new Error(`Server error (${res.status}). Check Render logs.`);
                    }
                    const data = await res.json();
                    console.log('Coach response:', data);
                    if (typeof data.queuePosition === 'number' && data.queuePosition > 0) {
                        showError(`Request was queued (position ${data.queuePosition}).`);
                    }
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    const msg = data.message || 'No response from coach.';
                    coachingText.textContent = msg;
                    renderDayCards(msg);
                    coachingResponse.style.display = 'block';
                    await loadHistory();
                } catch (err) {
                    console.error('Coaching error:', err);
                    showError(err.message || 'Network error. Is Render sleeping?');
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalSubmitText;
                }
            });

            function showError(msg) {
                errorSection.style.display = 'block';
                errorMessage.textContent = msg;
                setTimeout(() => { errorSection.style.display = 'none'; }, 4000);
            }

            // Initial history load
            loadHistory();
        });
    </script>
</head>
<body>
    <div class="container" style="display: flex; gap: 32px; align-items: flex-start;">
        <div style="flex: 1; min-width: 320px;">
            <header>
                <h1>AI Health Coach</h1>
                <p>Welcome! Connect Fitbit and chat with the coach.</p>
            </header>

            <div class="card" id="auth-section">
                <h2>Connect Your Fitbit</h2>
                <p>Authorize via our hosted app to sync your data.</p>
                <button id="connect-btn" class="btn btn-primary">Connect with Fitbit</button>
            </div>

            <div class="card" id="llm-section">
                <h2>Ask the Coach</h2>
                <p>Type a prompt for the coach. Example: "Create a weekly workout plan"</p>
                <div id="config-warning" style="display:none; background: #fff3cd; border: 1px solid #ffc107; color: #856404; padding: 12px; border-radius: 6px; margin-bottom: 12px; font-size: 0.9em;">
                    <strong>Configuration issue:</strong> <span id="config-message"></span>
                </div>
                <textarea id="prompt-input" rows="4" placeholder="Enter your prompt..."></textarea>
                <div style="margin-top:12px;">
                    <button id="submit-prompt" class="btn btn-secondary">Send Prompt</button>
                    <button id="check-config" class="btn" style="background: #6c757d; color: white; margin-left: 8px;">Check Config</button>
                    <span id="config-status" style="margin-left: 10px; font-size: 0.9em; color: #555;"></span>
                </div>
                <div id="coaching-response" style="display:none; margin-top:16px;">
                    <div class="coaching-message">
                        <div class="message-header"><strong>Your Coach Says:</strong></div>
                        <p id="coaching-text"></p>
                        <div id="day-cards" style="display:none; flex-wrap:wrap; gap:12px; margin-top:12px;"></div>
                    </div>
                </div>
                <div id="error-section" class="error-card" style="display:none;">
                    <h3>Error</h3>
                    <p id="error-message"></p>
                </div>
                <div id="history" class="card" style="display:none; margin-top:18px;">
                  <h3 style="margin-bottom:12px;">Recent Responses</h3>
                  <div id="history-items" style="display:flex; flex-direction:column; gap:10px;"></div>
                </div>
            </div>

            <footer>
                <p>Built with ❤️ for health and wellness</p>
            </footer>
        </div>
        <aside style="flex: 1; min-width: 280px; max-width: 400px;">
            <div class="card" style="background: #f8f9fa;">
                <h2 style="color: #764ba2;">About This App</h2>
                <p>
                    <strong>AI Health Coach</strong> is a modern web application that combines your Fitbit health data with the power of AI to deliver personalized, actionable health coaching. After connecting your Fitbit account, the app securely syncs your latest activity, heart rate, and sleep data. You can then interact with an AI coach by entering any health-related prompt—such as asking for a workout plan, nutrition advice, or motivation.
                </p>
                <p>
                    The AI analyzes your real Fitbit data and responds with tailored feedback, encouragement, and recommendations. Whether you want to improve your fitness, sleep better, or simply stay motivated, this tool provides instant, expert guidance. All data is processed securely, and you can use the app from any device.
                </p>
                <ul>
                    <li>Connects to Fitbit for real-time health data</li>
                    <li>Uses advanced AI models for coaching</li>
                    <li>Supports any health or fitness prompt</li>
                    <li>Works on desktop and mobile</li>
                </ul>
                <p style="margin-top: 12px; color: #555; font-size: 0.98em;">
                    <em>Your privacy is important: your Fitbit data is only used to generate coaching responses and is never shared.</em>
                </p>
            </div>
        </aside>
    </div>
</body>
</html>
