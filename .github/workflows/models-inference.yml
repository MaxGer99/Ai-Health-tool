name: GitHub Models Inference Demo

on:
  workflow_dispatch:
    inputs:
      prompt:
        description: "Prompt to send to GPT-5"
        required: true
        default: "Give me a short motivational health tip."
  schedule:
    - cron: "0 13 * * *" # Run daily at 13:00 UTC

jobs:
  run-inference:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run GitHub Models (chat completions)
        env:
          # Prefer fine-grained PAT if provided; fallback to repo GITHUB_TOKEN
          GH_TOKEN: ${{ secrets.GH_MODELS_TOKEN != '' && secrets.GH_MODELS_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          # Use dispatch input if present, else default text for scheduled runs
          PROMPT="${{ github.event.inputs.prompt }}"
          if [ -z "$PROMPT" ]; then
            PROMPT="Daily health tip, 1-2 sentences, friendly."
          fi
          echo "Sending prompt to GitHub Models..."
          RESPONSE=$(curl -sS -L \
            -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            -H "Content-Type: application/json" \
            https://models.github.ai/inference/chat/completions \
            -d "{\"model\":\"openai/gpt-5\",\"messages\":[{\"role\":\"user\",\"content\":\"$PROMPT\"}]}" )

          echo "Raw response:" && echo "$RESPONSE"
          echo "$RESPONSE" > response.json
          # Try to extract message content if present
          echo "$RESPONSE" | python3 -c "import sys, json; d=json.load(sys.stdin); print('\nModel reply:\n' + (d.get('choices',[{}])[0].get('message',{}).get('content','<no content>')))" || true

      - name: Save response artifact
        uses: actions/upload-artifact@v4
        with:
          name: models-response
          path: response.json
        if: always()
